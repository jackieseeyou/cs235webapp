{% extends 'layout.html' %}

{% block title %} Games {% endblock %}

<body>
    {% block sidebar_content %}
<div class="search_filter_container">
    <div class="search__container">
        <input type="text" class="search_bar" id="search-box" placeholder="Search games...">
        <div id="search-results" class="search-dropdown"></div>
    </div>
        <div id="genre-search-container">
        <input type="text" class="search_bar" id="genre-bar" placeholder="Search genres...">
        <ul id="genre-filter-dropdown" class="dropdown">
            {% for genre in genres%}
            <li>
                <input type="checkbox" id="{{ genre.genre_name }}" name="{{ genre.genre_name }}" value="{{ genre.genre_name }}">
                <label for="{{ genre.genre_name }}">{{ genre.genre_name }}</label>
            </li>
            {% endfor %}
        </ul>
    </div>
    <button id="apply-filters">apply filter(s)</button>
</div>
    {% endblock %}

    {% block content %}
    <div class="games__table__container">
        <table class="games__table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Release Date</th>
                    <th>Price</th>
                </tr>
            </thead>
            <tbody>
                {% for game in games %}
                <tr>
                    <td>
                        {{ game.game_id }}
                    </td>
                    <td>
                        <div id="game-link-container">
                        <a href="{{ url_for('description_bp.description', game_id = game.game_id) }}"id="game-image"><img src="{{ game.image }}"></img> {{ game.title }}</a>
                        </div>
                    </td>
                    <td>
                        {{ game.release_date }}
                    </td>
                    <td>
                        ${{ game.price }}
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {{ pagination.links }}
</body>

<script>
    document.getElementById('search-box').addEventListener('keyup', function() {
    let query = this.value;
    let resultsContainer = document.getElementById('search-results');

    if (query.length > 2) {
        fetch(`/search/${query}`)
            .then(response => response.json())
            .then(data => {
                resultsContainer.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(game => {
                        var game_id = game.game_id;
                        var url = '/browse/' + game_id;
                        resultsContainer.innerHTML += 
                        `
                            <a href=${ url }><div class="search-result-item">
                                <img src="${game.image}" alt="${game.title}" width="100px">
                                ${game.title}
                            </div></a>
                        `
                    });
                    resultsContainer.style.display = 'block';  // Show the results
                } else {
                    resultsContainer.style.display = 'none';   // Hide if no results
                }
            });
    } else {
        resultsContainer.style.display = 'none';   // Hide if input is too short
    }
});

// Optionally, close the dropdown when clicking elsewhere
document.addEventListener('click', function(event) {
    if (event.target.id !== 'search-box' && event.target.id !== 'search-results') {
        document.getElementById('search-results').style.display = 'none';
    };
});


    document.getElementById('genre-bar').addEventListener('click', function() {
    document.getElementById('genre-filter-dropdown').style.display = 'block';
});

document.addEventListener('click', function(event) {
    var filterDropdown = document.getElementById('genre-filter-dropdown');
    var isClickInsideFilterDropdown = filterDropdown.contains(event.target);
    if (event.target.id !== 'search-box' && event.target.id !== 'search-results' && event.target.id !== 'genre-bar' && !isClickInsideFilterDropdown) {
        document.getElementById('search-results').style.display = 'none';
        filterDropdown.style.display = 'none';
    }
});

document.getElementById('apply-filters').addEventListener('click', function() {
    var selectedGenres = [];
    var checkboxes = document.querySelectorAll('#genre-filter-dropdown input[type="checkbox"]');
    
    checkboxes.forEach(function(checkbox) {
        if (checkbox.checked) {
            selectedGenres.push(checkbox.id);
        }
    });

    var url = '/browse?page=1&genres=' + selectedGenres.join(',');

    window.location.href = url;
});

document.getElementById('genre-bar').addEventListener('keyup', function() {
    var input, filter, ul, li, a, i;
  input = document.getElementById("genre-bar");
  filter = input.value.toUpperCase();
  div = document.getElementById("genre-filter-dropdown");
  a = div.getElementsByTagName("li");
  for (i = 0; i < a.length; i++) {
    txtValue = a[i].textContent || a[i].innerText;
    if (txtValue.toUpperCase().indexOf(filter) > -1) {
      a[i].style.display = "";
    } else {
      a[i].style.display = "none";
    }
  }

    
});


    </script>
{% endblock %}